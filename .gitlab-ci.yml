stages:
  - build
  - test

build:
  stage: build
  image: fatesmartcontract/gitlab-ci-truffle-build
  cache: # Speed up builds
    key: $CI_COMMIT_REF_NAME
    paths:
      - node_modules
  script:
    - yarn install
    - truffle compile
    - yarn run build

test:
  stage: test
  image: node:8
  cache: # Speed up builds
    key: $CI_COMMIT_REF_NAME
    paths:
      - node_modules
  before_script:
    - npm install -g ganache-cli
    - npm install -g truffle
    - yarn install
    - ganache-cli -p 7545 > /dev/null &
    - sleep 1s
  script:
    - truffle compile
    - truffle migrate --reset
    - yarn run test
